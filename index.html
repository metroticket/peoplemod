<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>總運量查詢系統</title>
  
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/mobile-select@2.1.3/mobile-select.css" />
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/mobile-select@2.1.3/mobile-select.min.js"></script>

  <style>
    /* 基礎樣式維持不變，保持美觀 */
    :root { --primary: #3b82f6; --bg: #f3f4f6; --card: #ffffff; --text: #1f2937; }
    body { font-family: -apple-system, BlinkMacSystemFont, Roboto, Arial, sans-serif; margin: 0; padding: 30px 20px 80px 20px; background: var(--bg); color: var(--text); -webkit-tap-highlight-color: transparent; }
    .form-group { margin: 0 auto; background: var(--card); padding: 25px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
    h1 { font-size: 20px; text-align: center; margin-bottom: 25px; color: #111827; font-weight: 700; }
    label { display: block; margin-bottom: 8px; font-size: 14px; color: #6b7280; font-weight: 600; }
    
    .station-selection { display: flex; gap: 12px; margin-bottom: 10px; }
    .station-btn { flex: 1; padding: 14px; border: 1px solid #e5e7eb; background: #f9fafb; color: #9ca3af; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .station-btn.selected { background: #eff6ff; color: var(--primary); border-color: var(--primary); box-shadow: 0 2px 4px rgba(59, 130, 246, 0.15); }
    #selected-station { font-size: 13px; color: var(--primary); margin-bottom: 20px; text-align: right; height: 18px; font-weight: 500; }

    /* 模擬按鈕 */
    .picker-trigger {
      width: 100%; padding: 16px; margin-bottom: 25px; font-size: 17px; font-weight: 500;
      border: 1px solid #e5e7eb; border-radius: 12px; background: #fff; color: #374151;
      box-sizing: border-box; display: flex; justify-content: space-between; align-items: center;
      cursor: pointer; min-height: 54px;
    }
    .picker-trigger:active { background-color: #f0f0f0; } /* 點擊回饋 */
    .picker-trigger.placeholder { color: #9ca3af; }
    .picker-trigger::after { content: ''; width: 8px; height: 8px; border-top: 2px solid #ccc; border-right: 2px solid #ccc; transform: rotate(45deg); margin-right: 5px; }

    select { width: 100%; padding: 16px; margin-bottom: 25px; font-size: 16px; border: 1px solid #e5e7eb; border-radius: 12px; background: #fff; -webkit-appearance: none; }
    
    #submit { width: 100%; padding: 18px; background: linear-gradient(135deg, #3b82f6, #2563eb); color: #fff; border: none; border-radius: 14px; font-size: 18px; font-weight: 700; cursor: pointer; margin-top: 10px; box-shadow: 0 8px 20px rgba(37, 99, 235, 0.25); }
    #submit:active { transform: scale(0.98); }
    .error-message { color: #ef4444; margin-top: 20px; text-align: center; font-size: 14px; display: none; }

    /* 除錯區塊 (確保您能看到狀態) */
    #debug-console {
        position: fixed; bottom: 0; left: 0; width: 100%; height: 60px;
        background: #333; color: #0f0; font-size: 10px; padding: 5px;
        overflow-y: scroll; z-index: 999999; opacity: 0.8;
        display: block; /* 如果不想看到可以設 none */
    }
  </style>
</head>
<body>

  <div class="form-group">
    <h1>總運量查詢系統</h1>

    <label>交易類型</label>
    <div class="station-selection">
      <button id="station-in"  class="station-btn">進站</button>
      <button id="station-out" class="station-btn">出站</button>
    </div>
    <p id="selected-station">尚未選擇</p>

    <label>選擇車站</label>
    <select id="station-dropdown">
      <option value="">請選擇車站</option>
      <option value="A1">A1 台北車站</option>
      <option value="A2">A2 三重站</option>
      <option value="A3">A3 新北產業園區站</option>
      <option value="A4">A4 新莊副都心站</option>
      <option value="A5">A5 泰山站</option>
      <option value="A6">A6 泰山貴和站</option>
      <option value="A7">A7 體育大學站</option>
      <option value="A8">A8 長庚醫院站</option>
      <option value="A9">A9 林口站</option>
      <option value="A10">A10 山鼻站</option>
      <option value="A11">A11 坑口站</option>
      <option value="A12">A12 機場第一航廈站</option>
      <option value="A13">A13 機場第二航廈站</option>
      <option value="A14a">A14a 機場旅館站</option>
      <option value="A15">A15 大園站</option>
      <option value="A16">A16 橫山站</option>
      <option value="A17">A17 領航站</option>
      <option value="A18">A18 高鐵桃園站</option>
      <option value="A19">A19 桃園體育園區站</option>
      <option value="A20">A20 興南站</option>
      <option value="A21">A21 環北站</option>
      <option value="A22">A22 老街溪站</option>
    </select>

    <label>開始時間 (滾輪選擇)</label>
    <div id="btn-start" class="picker-trigger placeholder">點擊選擇...</div>
    
    <div id="trigger-start" style="display:none;"></div>
    <input type="hidden" id="input-start">

    <label>結束時間 (滾輪選擇)</label>
    <div id="btn-end" class="picker-trigger placeholder">請先選擇開始時間</div>
    <div id="trigger-end" style="display:none;"></div>
    <input type="hidden" id="input-end">

    <button id="submit">查詢運量</button>
    <div id="error-message" class="error-message"></div>
  </div>

  <div id="debug-console">系統記錄:<br></div>

  <script>
    // ===== 小工具：顯示 Log 到螢幕上 (因為手機看不到 console) =====
    function logToScreen(msg) {
        const consoleDiv = document.getElementById('debug-console');
        const time = new Date().toTimeString().split(' ')[0];
        consoleDiv.innerHTML += `[${time}] ${msg}<br>`;
        consoleDiv.scrollTop = consoleDiv.scrollHeight;
        console.log(msg);
    }

    logToScreen("程式開始載入...");

    var liffID = '2006470777-N3VdwgyO'; 
    let stationType = '';
    
    // 存放 MobileSelect 實例
    let msStart = null;
    let msEnd = null;

    // 1. 產生資料
    function generateData() {
        // 日期
        const dates = [];
        const start = new Date("2025-01-01");
        const end = new Date();
        end.setDate(end.getDate() + 365); 
        const weekMap = ['日', '一', '二', '三', '四', '五', '六'];
        let curr = new Date(start);
        while(curr <= end) {
            const Y = curr.getFullYear();
            const M = String(curr.getMonth()+1).padStart(2,'0');
            const D = String(curr.getDate()).padStart(2,'0');
            const w = weekMap[curr.getDay()];
            // v2 格式: {id: '...', value: '...'}
            dates.push({ id: `${Y}-${M}-${D}`, value: `${Y}-${M}-${D} (${w})` });
            curr.setDate(curr.getDate() + 1);
        }

        // 小時
        const hours = [];
        for(let i=0; i<24; i++){
            const t = String(i).padStart(2,'0');
            hours.push({ id: t, value: t + '時' });
        }

        // 分鐘 (00, 15, 30, 45)
        const mins = [
            { id: '00', value: '00分' },
            { id: '15', value: '15分' },
            { id: '30', value: '30分' },
            { id: '45', value: '45分' }
        ];

        return { dates, hours, mins };
    }

    const { dates, hours, mins } = generateData();
    logToScreen(`資料產生完成: 日期${dates.length}筆`);

    // 2. 取得預設時間
    function getSnappedNow() {
        const now = new Date();
        const ms = 1000 * 60 * 15;
        const snapped = new Date(Math.round(now.getTime() / ms) * ms);
        
        const Y = snapped.getFullYear();
        const M = String(snapped.getMonth()+1).padStart(2,'0');
        const D = String(snapped.getDate()).padStart(2,'0');
        const h = String(snapped.getHours()).padStart(2,'0');
        const m = String(snapped.getMinutes()).padStart(2,'0');
        
        return {
            dateStr: `${Y}-${M}-${D}`,
            hStr: h,
            mStr: m,
            fullDisplay: `${Y}-${M}-${D} ${h}:${m}`
        };
    }

    // ===== 初始化 MobileSelect (使用 v2 語法) =====
    function initMobilePickers() {
        if(typeof MobileSelect === 'undefined') {
            logToScreen("嚴重錯誤: MobileSelect 插件未載入");
            return;
        }

        const nowObj = getSnappedNow();
        
        // --- 設定開始時間 ---
        // 技巧：我們不讓插件綁定點擊，我們自己綁定
        // v2 初始化
        msStart = new MobileSelect({
            trigger: "#trigger-start", // 綁定到那個隱藏的 div
            title: "選擇開始時間",
            wheels: [
                { data: dates },
                { data: hours },
                { data: mins }
            ],
            position: [0, 0, 0], // 先設為 0，稍後手動定位
            transitionEnd: function(indexArr, data) {},
            callback: function(indexArr, data) {
                // data 格式在 v2 可能是陣列
                const d = data[0];
                const h = data[1];
                const m = data[2];

                // v2 的 data 結構可能直接是物件，視版本而定，這裡做個防呆
                const datePart = d.id || d;
                const hourPart = h.id || h;
                const minPart  = m.id || m;
                const dateText = d.value || d;
                
                const finalStr = `${datePart} ${hourPart}:${minPart}`;
                
                // 更新隱藏值
                document.getElementById('input-start').value = finalStr;
                // 更新按鈕顯示
                const btn = document.getElementById('btn-start');
                btn.textContent = `${dateText} ${hourPart}:${minPart}`;
                btn.classList.remove('placeholder');

                // 連動結束時間
                if(msEnd) {
                    // v2 的 locatePosition 語法: sliderIndex, posIndex
                    msEnd.locatePosition(0, indexArr[0]);
                    msEnd.locatePosition(1, indexArr[1]);
                    msEnd.locatePosition(2, indexArr[2]);
                }
            }
        });

        // 手動定位到現在時間 (這是最安全的 initValue 替代方案)
        // 我們簡單地遍歷尋找 index
        let dIndex = dates.findIndex(x => x.id === nowObj.dateStr);
        let hIndex = hours.findIndex(x => x.id === nowObj.hStr);
        let mIndex = mins.findIndex(x => x.id === nowObj.mStr);
        
        if(dIndex < 0) dIndex = 0;
        if(hIndex < 0) hIndex = 0;
        if(mIndex < 0) mIndex = 0;

        // 定位
        msStart.locatePosition(0, dIndex);
        msStart.locatePosition(1, hIndex);
        msStart.locatePosition(2, mIndex);

        // 預填顯示文字
        document.getElementById('btn-start').textContent = nowObj.fullDisplay;
        document.getElementById('input-start').value = nowObj.fullDisplay;
        document.getElementById('btn-start').classList.remove('placeholder');

        // --- 設定結束時間 ---
        msEnd = new MobileSelect({
            trigger: "#trigger-end",
            title: "選擇結束時間",
            wheels: [
                { data: dates },
                { data: hours },
                { data: mins }
            ],
            position: [dIndex, hIndex, mIndex], // 直接定位
            callback: function(indexArr, data) {
                const d = data[0];
                const h = data[1];
                const m = data[2];
                
                const datePart = d.id || d;
                const hourPart = h.id || h;
                const minPart  = m.id || m;
                const dateText = d.value || d;

                const finalStr = `${datePart} ${hourPart}:${minPart}`;
                document.getElementById('input-end').value = finalStr;
                
                const btn = document.getElementById('btn-end');
                btn.textContent = `${dateText} ${hourPart}:${minPart}`;
                btn.classList.remove('placeholder');
            }
        });

        logToScreen("滾輪初始化完成");
    }

    // 3. 手動綁定點擊事件 (保證有反應)
    function initClicks() {
        // 進出站按鈕
        document.getElementById('station-in').addEventListener('click', function(){
            stationType='(進站)';
            document.getElementById('selected-station').textContent='目前狀態：進站';
            this.classList.add('selected');
            document.getElementById('station-out').classList.remove('selected');
        });

        document.getElementById('station-out').addEventListener('click', function(){
            stationType='(出站)';
            document.getElementById('selected-station').textContent='目前狀態：出站';
            this.classList.add('selected');
            document.getElementById('station-in').classList.remove('selected');
        });

        // ★★★ 關鍵：手動呼叫滾輪顯示 ★★★
        document.getElementById('btn-start').addEventListener('click', function() {
            logToScreen("點擊了開始時間");
            if(msStart) msStart.show();
            else logToScreen("錯誤：開始時間滾輪尚未就緒");
        });

        document.getElementById('btn-end').addEventListener('click', function() {
            logToScreen("點擊了結束時間");
            if(msEnd) msEnd.show();
            else logToScreen("錯誤：結束時間滾輪尚未就緒");
        });

        // 送出
        document.getElementById('submit').addEventListener('click', function(){
            const startVal = document.getElementById('input-start').value;
            const endVal   = document.getElementById('input-end').value;
            const station  = document.getElementById('station-dropdown').value;
            const errorDiv = document.getElementById('error-message');

            if(!station || !startVal || !endVal || !stationType) {
                errorDiv.innerText = '請完整填寫所有欄位';
                errorDiv.style.display = 'block';
                return;
            }
            if(startVal >= endVal) {
                errorDiv.innerText = '結束時間必須晚於開始時間';
                errorDiv.style.display = 'block';
                return;
            }

            const msg = `功能：總運量${stationType}\n車站: ${station}\n開始時間: ${startVal}\n結束時間: ${endVal}`;
            logToScreen("準備發送: " + msg);

            if (liff.isInClient()) {
                liff.sendMessages([{ type:'text', text: msg }])
                    .then(()=>{ liff.closeWindow(); })
                    .catch(err=>{ logToScreen("發送失敗: " + err); });
            } else {
                alert(msg);
            }
        });
    }

    // 啟動
    window.addEventListener('load', function(){
        try {
            initMobilePickers();
            initClicks();
            
            liff.init({ liffId: liffID }).then(()=>{
                logToScreen("LIFF 初始化成功");
            }).catch(err => {
                logToScreen("LIFF 初始化失敗: " + err);
            });
        } catch(e) {
            logToScreen("系統崩潰: " + e.message);
        }
    });

  </script>
</body>
</html>
